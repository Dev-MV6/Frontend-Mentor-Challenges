name: GitHub Pages deployment

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ['main']

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    name: Build üèóÔ∏è
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Build all projects in repository
        run: |
          mkdir ./_site
          shopt -s extglob
          for f in !(_site); do
            if [ -d "$f" ]; then
              # Check if directory contains an npm project
              if [ -f "$f/package.json" ]; then
                echo "[*] \"$f\" is an npm project";
                echo "- Installing dependencies for \"$f\"";
                npm install --prefix "$f"
                echo "- Building: \"$f\"";
                npm run build --prefix "$f"
                echo "- Moving \"$f\" static files to \"./_site\""
                mv "$f/dist" "./_site/$f"
              else
                echo "[*] \"$f\" is a normal project";
                echo "Moving \"$f\" directly to \"./_site\""
                mv "$f" ./_site/
              fi
            fi
          done
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2

  deploy:
    name: Deploy üöÄ
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
